{% extends 'base.html.twig' %}

{% block title %}Modifier le Quiz{% endblock %}

{% block body %}
    <h1>Modifier le Quiz</h1>
    <form id="quiz-form" method="post" action="{{ path('quizz_update', { id: quiz.id }) }}" enctype="multipart/form-data">
        <div class="form-group">
            <label for="title">Titre du Quiz</label>
            <input type="text" class="form-control" id="title" name="title" value="{{ quiz.name }}" required>
            <div class="form-group-description">
                <label for="quizz-description">Description du quiz :</label>
                <input type="text" id="quizz-description" name="quizzDescription" value="{{ quiz.description }}" required>
            </div>
            <div>
                <label for="time-weight">Poids du Temps de Réponse (0 à 1) :</label>
                <input type="number" id="time-weight" name="timeWeight" min="0" max="1" step="0.01" required>
            </div>
            <div>
                <label for="correct-answer-weight">Poids des Bonnes Réponses (0 à 1) :</label>
                <input type="number" id="correct-answer-weight" name="correctAnswerWeight" min="0" max="1" step="0.01" required>
            </div>
            <div>
                <label>Tags :</label>
                <div class="tag-checkboxes">
                    {% for tag in tags %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="tags[]" value="{{ tag.id }}" id="tag-{{ tag.id }}"
                                   {% if tag in quiz.tags %}checked{% endif %}>
                            <label class="form-check-label" for="tag-{{ tag.id }}">
                                {{ tag.name }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div id="questions-container">
            {% for question in quiz.questions %}
                <div class="question">
                    <h3>Question</h3>
                    <input type="text" class="form-control" name="questions[{{ loop.index0 }}][text]" value="{{ question.questionText }}" required>
                    <div>
                        <label for="question-type-{{ loop.index0 }}">Type de Question :</label>
                        <select id="question-type-{{ loop.index0 }}" name="questions[{{ loop.index0 }}][type]" required>
                            <option value="multiple-choice" {{ question.isTextual ? '' : 'selected' }}>Choix multiples</option>
                            <option value="textual" {{ question.isTextual ? 'selected' : '' }}>Textuelle</option>
                        </select>
                    </div>
                    <div id="multiple-choice-answers-{{ loop.index0 }}" style="{{ question.isTextual ? 'display: none;' : '' }}">
                        <div class="answers-container">
                            {% for answer in question.answers %}
                                <div class="answer">
                                    <input type="text" class="form-control" name="questions[{{ loop.parent.loop.index0 }}][answers][{{ loop.index0 }}][text]" value="{{ answer.textAnswer }}" required>
                                    <label>
                                        <input type="checkbox" name="questions[{{ loop.parent.loop.index0 }}][correctAnswers][]" value="{{ loop.index0 }}" {% if question.goodAnswers.contains(answer) %}checked{% endif %}> Correcte
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-secondary add-answer">Ajouter une Réponse</button>
                    </div>
                    <div id="textual-answer-{{ loop.index0 }}" style="{{ question.isTextual ? '' : 'display: none;' }}">
                        <div>
                            <label for="correct-textual-answer-{{ loop.index0 }}">Réponse correcte :</label>
                            <input type="text" id="correct-textual-answer-{{ loop.index0 }}" name="questions[{{ loop.index0 }}][correctTextualAnswer]" value="{{ question.correctTextualAnswer }}" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger remove-question">Supprimer la Question</button>
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-question" class="btn btn-secondary">Ajouter une Question</button>
        <button type="submit" class="btn btn-primary">Mettre à jour le Quiz</button>
    </form>

    <style>
        .tag-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .form-check {
            display: flex;
            align-items: center;
        }
        .form-check-input {
            margin-right: 5px;
        }
    </style>

    <script>
        document.getElementById('add-question').addEventListener('click', function() {
            const questionsContainer = document.getElementById('questions-container');
            const questionIndex = questionsContainer.children.length;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question';
            questionDiv.innerHTML = `
                <h3>Question</h3>
                <input type="text" class="form-control" name="questions[${questionIndex}][text]" required>
                <div>
                    <label for="question-type-${questionIndex}">Type de Question :</label>
                    <select id="question-type-${questionIndex}" name="questions[${questionIndex}][type]" required>
                        <option value="multiple-choice">Choix multiples</option>
                        <option value="textual">Textuelle</option>
                    </select>
                </div>
                <div id="multiple-choice-answers-${questionIndex}">
                    <div class="answers-container">
                        <div class="answer">
                            <input type="text" class="form-control" name="questions[${questionIndex}][answers][0][text]" required>
                            <label>
                                <input type="checkbox" name="questions[${questionIndex}][correctAnswers][]" value="0"> Correcte
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary add-answer">Ajouter une Réponse</button>
                </div>
                <div id="textual-answer-${questionIndex}" style="display: none;">
                    <div>
                        <label for="correct-textual-answer-${questionIndex}">Réponse correcte :</label>
                        <input type="text" id="correct-textual-answer-${questionIndex}" name="questions[${questionIndex}][correctTextualAnswer]" required>
                    </div>
                </div>
                <button type="button" class="btn btn-danger remove-question">Supprimer la Question</button>
            `;
            questionsContainer.appendChild(questionDiv);
            document.getElementById(`question-type-${questionIndex}`).addEventListener('change', function() {
                toggleAnswerType(this.value, questionIndex);
            });
        });

        document.getElementById('questions-container').addEventListener('click', function(event) {
            if (event.target.classList.contains('add-answer')) {
                const answersContainer = event.target.previousElementSibling;
                const questionIndex = Array.from(answersContainer.parentElement.parentElement.children).indexOf(answersContainer.parentElement);
                const answerIndex = answersContainer.children.length;
                const answerDiv = document.createElement('div');
                answerDiv.className = 'answer';
                answerDiv.innerHTML = `
                    <input type="text" class="form-control" name="questions[${questionIndex}][answers][${answerIndex}][text]" required>
                    <label>
                        <input type="checkbox" name="questions[${questionIndex}][correctAnswers][]" value="${answerIndex}"> Correcte
                    </label>
                `;
                answersContainer.appendChild(answerDiv);
            }
        });

        document.getElementById('questions-container').addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-question')) {
                event.target.parentElement.remove();
            }
        });

        function toggleAnswerType(type, index) {
            const multipleChoiceAnswers = document.getElementById(`multiple-choice-answers-${index}`);
            const textualAnswer = document.getElementById(`textual-answer-${index}`);
            if (type === 'multiple-choice') {
                multipleChoiceAnswers.style.display = 'block';
                textualAnswer.style.display = 'none';
            } else {
                multipleChoiceAnswers.style.display = 'none';
                textualAnswer.style.display = 'block';
            }
        }

        document.querySelectorAll('[id^="question-type-"]').forEach(function(element) {
            element.addEventListener('change', function() {
                const index = this.id.split('-')[2];
                toggleAnswerType(this.value, index);
            });
        });
    </script>
{% endblock %}
